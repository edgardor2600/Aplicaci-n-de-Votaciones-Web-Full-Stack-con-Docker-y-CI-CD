name: CI - Frontend Tests

on:
  push:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-ci.yml'
  # EjecuciÃ³n manual para frontend
  workflow_dispatch:
    inputs:
      run_docker_build:
        description: 'Construir imagen Docker del frontend'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '18'

jobs:
  frontend-validation:
    name: ValidaciÃ³n del Frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate frontend structure
        run: |
          echo "ðŸ” Validando estructura de archivos del frontend..."
          
          required_files=(
            "frontend/www/index.html"
            "frontend/www/css/styles.css"
            "frontend/www/js/api.js"
            "frontend/www/js/components.js"
            "frontend/www/js/app.js"
            "frontend/nginx/nginx.conf"
            "frontend/nginx/default.conf"
            "frontend/Dockerfile"
          )
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Archivo faltante: $file"
              exit 1
            else
              echo "âœ… $file encontrado"
            fi
          done
          
          echo "âœ… Estructura de archivos validada"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          echo "ðŸ“¦ Verificando sintaxis de archivos JavaScript..."
          chmod +x frontend/test-frontend.sh
          ./frontend/test-frontend.sh

      - name: Validate CSS structure
        run: |
          echo "ðŸŽ¨ Validando estructura CSS..."
          if grep -q "root" frontend/www/css/styles.css; then
            echo "âœ… Variables CSS encontradas"
          else
            echo "âŒ Variables CSS no encontradas"
            exit 1
          fi
          
          if grep -q "responsive" frontend/www/css/styles.css; then
            echo "âœ… Media queries para responsive design encontradas"
          else
            echo "âš ï¸  No se encontraron media queries"
          fi

      - name: Validate HTML structure
        run: |
          echo "ðŸ—ï¸  Validando estructura HTML..."
          if grep -q "Cats vs Dogs" frontend/www/index.html; then
            echo "âœ… TÃ­tulo de la aplicaciÃ³n encontrado"
          else
            echo "âŒ TÃ­tulo no encontrado"
            exit 1
          fi
          
          if grep -q "data-option" frontend/www/index.html; then
            echo "âœ… Elementos de votaciÃ³n encontrados"
          else
            echo "âŒ Elementos de votaciÃ³n no encontrados"
            exit 1
          fi

  frontend-tests:
    name: Frontend E2E Tests
    runs-on: ubuntu-latest
    needs: frontend-validation

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Dependencies
        working-directory: ./frontend
        run: |
          echo "ðŸ“¦ Installing frontend dependencies..."
          npm install

      - name: Install Playwright Browsers
        working-directory: ./frontend
        run: |
          echo "ðŸŒ Installing Playwright browsers..."
          npx playwright install --with-deps

      - name: Run Playwright Tests
        working-directory: ./frontend
        run: |
          echo "ðŸ§ª Running Playwright end-to-end tests..."
          npx playwright test


  docker-build:
    name: Construir Imagen Docker
    runs-on: ubuntu-latest
    needs: frontend-validation
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.run_docker_build == 'true' ||
      contains(github.event.head_commit.message, '[docker]') ||
      contains(github.event.pull_request.title, '[docker]')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build frontend Docker image
        run: |
          echo "ðŸ³ Construyendo imagen Docker del frontend..."
          docker build -t voting-frontend:latest frontend/
          
      - name: Test Docker image
        run: |
          echo "ðŸ§ª Probando imagen Docker..."
          
          # Ejecutar contenedor temporalmente
          docker run -d --name frontend-test -p 8080:80 voting-frontend:latest
          
          # Esperar a que inicie
          sleep 5
          
          # Verificar que responde
          if curl -f http://localhost:8080/health; then
            echo "âœ… Imagen Docker responde correctamente"
          else
            echo "âŒ Imagen Docker no responde"
            exit 1
          fi
          
          # Limpiar
          docker stop frontend-test
          docker rm frontend-test
          
      - name: Save Docker image
        if: env.CI_PUSH_REGISTRY == 'true'
        run: |
          echo "ðŸ’¾ Guardando imagen Docker..."
          docker save voting-frontend:latest > frontend-image.tar
          
      - name: Upload Docker artifact
        if: env.CI_PUSH_REGISTRY == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: frontend-docker-image
          path: frontend-image.tar