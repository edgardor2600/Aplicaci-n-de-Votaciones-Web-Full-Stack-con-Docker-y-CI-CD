name: CI - Main Orchestrator

# Trigger principal para casos especiales
on:
  push:
    branches: [ main ]
    # Solo ejecutar cuando se cambien archivos de configuraciÃ³n del workflow
    paths:
      - '.github/workflows/*.yml'
      - '*.md'
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, ready_for_review]
  # Workflow manual para orquestaciÃ³n completa
  workflow_dispatch:
    inputs:
      run_backend:
        description: 'Ejecutar tests del backend'
        required: false
        default: 'false'
        type: boolean
      run_frontend:
        description: 'Ejecutar tests del frontend'
        required: false
        default: 'false'
        type: boolean
      run_full_ci:
        description: 'Ejecutar CI completo'
        required: false
        default: 'false'
        type: boolean

jobs:
  # Job placeholder para cuando solo se quieren tests especÃ­ficos
  run_specific_tests:
    name: Ejecutar Tests EspecÃ­ficos
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Mostrar opciones seleccionadas
        run: |
          echo "ðŸ”§ Tests seleccionados:"
          echo "Backend: ${{ github.event.inputs.run_backend }}"
          echo "Frontend: ${{ github.event.inputs.run_frontend }}"
          echo "CI Completo: ${{ github.event.inputs.run_full_ci }}"
          
          if [ "${{ github.event.inputs.run_full_ci }}" = "true" ]; then
            echo "ðŸš€ Ejecuta manualmente: backend-ci.yml y frontend-ci.yml"
            echo "ðŸ’¡ Los workflows individuales se activarÃ¡n automÃ¡ticamente por cambios en sus respectivos directorios"
          elif [ "${{ github.event.inputs.run_backend }}" = "true" ]; then
            echo "ðŸ Ve a Actions â†’ Ejecutar 'CI - Backend Tests' manualmente"
          elif [ "${{ github.event.inputs.run_frontend }}" = "true" ]; then
            echo "ðŸŒ Ve a Actions â†’ Ejecutar 'CI - Frontend Tests' manualmente"
          else
            echo "âœ… NingÃºn test especÃ­fico seleccionado"
          fi

  # Job para casos especiales (solo cuando se modifican workflows)
  workflow_maintenance:
    name: Mantenimiento de Workflows
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.modified, '.github/workflows/')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validar configuraciÃ³n de workflows
        run: |
          echo "ðŸ”§ Validando configuraciÃ³n de workflows..."
          
          # Verificar que existen los workflows separados
          if [ -f ".github/workflows/backend-ci.yml" ]; then
            echo "âœ… backend-ci.yml encontrado"
          else
            echo "âŒ backend-ci.yml no encontrado"
            exit 1
          fi
          
          if [ -f ".github/workflows/frontend-ci.yml" ]; then
            echo "âœ… frontend-ci.yml encontrado"
          else
            echo "âŒ frontend-ci.yml no encontrado"
            exit 1
          fi
          
          # Verificar sintaxis bÃ¡sica YAML
          if command -v yq &> /dev/null; then
            echo "ðŸ” Validando sintaxis YAML..."
            yq eval '.name' .github/workflows/backend-ci.yml > /dev/null || exit 1
            yq eval '.name' .github/workflows/frontend-ci.yml > /dev/null || exit 1
            echo "âœ… Sintaxis YAML vÃ¡lida"
          fi
          
          echo "âœ… ConfiguraciÃ³n de workflows validada"
