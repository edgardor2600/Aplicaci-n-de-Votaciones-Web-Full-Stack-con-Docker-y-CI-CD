name: CI - Tests Integrados

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/main.yml'
      - '*.sh'
  pull_request:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/main.yml'
  # Opcional: Ejecutar tests manualmente
  workflow_dispatch:
    inputs:
      run_frontend_tests:
        description: 'Ejecutar tests del frontend'
        required: false
        default: 'true'
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  backend-tests:
    name: Tests del Backend
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' && contains(github.event.head_commit.modified, 'backend/') ||
      github.event_name == 'pull_request' && contains(github.event.pull_request.title, '[backend]') ||
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.pull_request.title, '[full]') ||
      github.event_name == 'pull_request' && contains(github.event.pull_request.title, '[all]')

    services:
      postgres:
        image: postgres:14-alpine
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: votes
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U user -d votes"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install backend dependencies
        run: |
          pip install -r backend/requirements.txt

      - name: Wait for Postgres & init schema
        env:
          PGPASSWORD: password
        run: |
          for i in {1..30}; do
            if pg_isready -h 127.0.0.1 -p 5432 -U user -d votes; then
              break
            fi
            sleep 1
          done
          psql -h 127.0.0.1 -p 5432 -U user -d votes -f init.sql

      - name: Run backend tests
        env:
          PGPASSWORD: password
          DB_HOST: 127.0.0.1
          DB_USER: user
          DB_PASS: password
          DB_NAME: votes
        run: |
          pytest backend/tests/test_api.py -v

  frontend-tests:
    name: Tests del Frontend
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' && contains(github.event.head_commit.modified, 'frontend/') ||
      github.event_name == 'pull_request' && contains(github.event.pull_request.title, '[frontend]') ||
      github.event_name == 'workflow_dispatch' && github.event.inputs.run_frontend_tests == 'true' ||
      contains(github.event.pull_request.title, '[full]') ||
      contains(github.event.pull_request.title, '[all]') ||
      github.event_name == 'push' && contains(github.event.head_commit.message, '[frontend]') ||
      github.event_name == 'push' && contains(github.event.head_commit.message, '[full]')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          chmod +x frontend/test-frontend.sh
          ./frontend/test-frontend.sh

      - name: Validate frontend structure
        run: |
          echo "ğŸ” Validando estructura de archivos del frontend..."
          if [ ! -f "frontend/www/index.html" ]; then
            echo "âŒ index.html no encontrado"
            exit 1
          fi
          if [ ! -f "frontend/www/css/styles.css" ]; then
            echo "âŒ styles.css no encontrado"
            exit 1
          fi
          if [ ! -f "frontend/www/js/app.js" ]; then
            echo "âŒ app.js no encontrado"
            exit 1
          fi
          if [ ! -f "frontend/nginx/default.conf" ]; then
            echo "âŒ nginx.conf no encontrado"
            exit 1
          fi
          echo "âœ… Estructura de archivos validada"

      - name: Build frontend Docker image (optional)
        if: env.CI_PUSH_IMAGES == 'true'
        run: |
          echo "ğŸ³ Construyendo imagen Docker del frontend..."
          docker build -t voting-frontend:latest frontend/
          docker save voting-frontend:latest > frontend-image.tar
          
      - name: Upload Docker image artifact
        if: env.CI_PUSH_IMAGES == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: frontend-docker-image
          path: frontend-image.tar

  integration-tests:
    name: Tests de IntegraciÃ³n
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    if: |
      contains(github.event.pull_request.title, '[integration]') ||
      contains(github.event.pull_request.title, '[full]') ||
      contains(github.event.pull_request.title, '[all]') ||
      github.event_name == 'push' && contains(github.event.head_commit.message, '[integration]') ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run integration tests
        run: |
          echo "ğŸš€ Ejecutando tests de integraciÃ³n completos..."
          echo "âœ… Backend y Frontend funcionando juntos"
          echo "ğŸ’¡ Esta secciÃ³n se puede expandir para incluir tests e2e"
